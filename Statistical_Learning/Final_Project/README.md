# Diffusion-Based Generative Age Estimation with Conformal Prediction

**Department of Statistical Sciences**
**Course:** Statistical Learning
**Academic Year:** 2024/2025
**Professors:** Pierpaolo Brutti
**Student:** Arman Feili (Matricola: 2101835)

## Project Overview

This project explores whether a conformal prediction (CP) system for age estimation can provide reliable confidence intervals when used on synthetic face images generated by a fine-tuned diffusion model. The main components are:

1. **Synthetic Image Generation:** Fine-tuning Stable Diffusion (v1.5) on the UTKFace dataset to generate realistic face images from text prompts describing age, gender, and race.
2. **Age and Gender Estimation:** Training deep learning models to estimate age (with conformal prediction for 90% confidence intervals) and gender from face images.
3. **Evaluation:** Assessing the reliability of the age estimatorâ€™s uncertainty intervals when applied to both real and synthetic faces.

## Main Steps

* **Data Preparation:**

  * Use the UTKFace dataset, clean and preprocess images, and balance the dataset for age, gender, and race diversity.
* **Training Predictive Models:**

  * Build neural networks for age regression (with Label Distribution Age Encoding) and binary gender classification.
  * Use conformal prediction to produce valid, adaptive confidence intervals for each age prediction.
* **Fine-Tuning the Diffusion Model:**

  * Fine-tune Stable Diffusion using UTKFace, enabling it to generate high-quality faces based on specified attributes.
* **Testing and Analysis:**

  * Generate synthetic faces from text prompts.
  * Evaluate the performance of the age estimator (with CP) and gender classifier on both real and generated images.
  * Analyze confidence interval coverage, prediction accuracy, and generative quality (using metrics like MSE, PSNR, SSIM, FID).

## Key Results

* The conformal prediction system achieved actual 92% coverage for 90% confidence intervals on test data.
* The diffusion model successfully generated realistic faces, with quality metrics confirming strong reconstructions and competitive generative performance.
* Confidence intervals were wider for extreme ages (very young/old), reflecting model uncertainty; accuracy and interval width were optimal for adult ages.
* All steps were performed in Python using PyTorch, TensorFlow, and open-source tools on Google Colab Pro.

## How to Use

1. **Run the notebook in Google Colab**

   * The code is organized into sections: data setup, preprocessing, model training, image generation, and evaluation.
2. **Download and Prepare UTKFace Dataset**

   * Place the dataset in your Google Drive and follow instructions for extraction and preprocessing in the notebook.
3. **Train Models**

   * Follow notebook cells to train both age/gender estimators and the diffusion model (requires Colab Pro for GPU access).
4. **Generate and Evaluate Images**

   * Use text prompts to create synthetic images and analyze predictions with confidence intervals.

## Dependencies

* Python 3.x
* PyTorch, TensorFlow, diffusers, torchvision, transformers
* Numpy, scikit-learn, matplotlib, seaborn
* Google Colab Pro (recommended for GPU memory)

## Notes

* All code and results are designed for reproducibility; random seeds are set and all configuration steps are described in the notebook.
* Training the diffusion model and predictive networks is resource-intensive and may require access to high-memory GPUs.

## References

* UTKFace Dataset ([https://www.kaggle.com/datasets/jangedoo/utkface-new](https://www.kaggle.com/datasets/jangedoo/utkface-new))
* Relevant research on label distribution age encoding, conformal prediction, and diffusion models (see project report for detailed citations)

---

## Citation

Project by Arman Feili, MSc. Data Science
Department of Statistical Sciences, Sapienza University of Rome
Academic Year 2024/2025
Email: [feili.2101835@studenti.uniroma1.it](mailto:feili.2101835@studenti.uniroma1.it)
